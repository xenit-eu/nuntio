version: '3.4'
services:
  nuntio:
    image: ${DOCKER_IMAGE}
    environment:
      JAVA_OPTS_CONSUL: -Dnuntio.consul.host=consul
      JAVA_OPTS_LOGGING: -Dlogging.level.be.vbgn.nuntio.engine=DEBUG -Dlogging.level.be.vbgn.nuntio.docker.config.PublishedPortConfigurationModifier=ERROR
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock

  consul:
    image: docker.io/library/consul:latest
    #image: hub.xenit.eu/public/consul:1.4.4
    command:
      - agent
      - '-dev'
      - '-client=0.0.0.0'
    labels:
      nuntio.vbgn.be/service: consul-test
      nuntio.vbgn.be/tags: server,leader
      nuntio.vbgn.be/metadata/internal-address: consul-test.vbgn.be
    ports:
      - ${DOCKER_IP}::8500

  ctpl:
    image: hub.xenit.eu/public/consul-template:latest
    command:
      - -config=/config
    volumes:
      - type: bind
        source: ./ctpl/config
        target: /config
      - type: bind
        source: ./ctpl/templates
        target: /templates
        read_only: true
      - type: tmpfs
        target: /output
