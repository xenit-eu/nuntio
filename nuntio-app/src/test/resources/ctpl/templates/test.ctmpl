{{define "FQDN"}}{{ .Name }}.xenit.eu{{end}}
{{- $requiredTags := parseJSON `["proxy-http","production"]` -}}
{{range services}}
    {{- if or ( and (contains "proxy-http" .Tags) (eq (len .Tags) 1) ) ( containsAll $requiredTags .Tags ) -}}

        {{- if service .Name }}

            upstream upstream-{{ .Name }} {
            ip_hash;
            {{ range service .Name }}
                server {{ .Address }}:{{ .Port }}; # {{ .Name }} {{ .Tags }}

            {{- end }}
            }

            server {
            server_name {{ template "FQDN" . }};

            location / {
            {{- if in .Tags "enable-cors" -}}
                include /etc/nginx/include.d/enable-cors.conf;
            {{- end }}
            {{- if in .Tags "enable-cors-local" -}}
                include /etc/nginx/include.d/enable-cors-localhost-8080.conf;
            {{- end }}
            proxy_pass  http://upstream-{{ .Name }};
            }
            }

        {{- end -}}
    {{- end -}}
{{- end }}


{{define "FQDNdev"}}{{ .Name }}.dev.xenit.eu{{end}}
{{define "TARGETdev"}}{{ .Name }}.dev.xenit.eu{{end}}
{{- $forwardTags := parseJSON `["proxy-http","proxy-forward-public","dev"]` -}}
{{- $proxyTags := parseJSON `["proxy-http","dev"]` -}}
{{range services}}
    {{- if containsAll $proxyTags .Tags -}}

        {{- if containsAll $forwardTags .Tags -}}

            {{- if service .Name }}

                upstream upstream-{{ .Name }} {
                server {{ template "TARGETdev" . }}:443; # {{ .Name }}
                }

                server {
                listen 443 ssl;
                server_name {{ template "FQDNdev" . }};

                ssl_certificate           /etc/letsencrypt/live/dev.xenit.eu/fullchain.pem;
                ssl_certificate_key       /etc/letsencrypt/live/dev.xenit.eu/privkey.pem;
                ssl_trusted_certificate   /etc/letsencrypt/live/dev.xenit.eu/chain.pem;

                location / {
                proxy_set_header  Host                $host;
                proxy_set_header  X-Real-IP           $remote_addr;
                proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;
                proxy_set_header  X-Forwarded-Proto   $scheme;
                proxy_set_header  X-Forwarded-Port    $server_port;
                proxy_set_header  X-Forwarded-Host    $host;
                proxy_ssl_session_reuse off;
                proxy_ssl_server_name on;
                proxy_pass  https://upstream-{{ .Name }};
                }
                }

            {{- end -}}

        {{- else -}}

            {{- if service .Name }}

                server {
                listen 443 ssl;
                server_name {{ template "FQDNdev" . }};

                ssl_certificate           /etc/letsencrypt/live/dev.xenit.eu/fullchain.pem;
                ssl_certificate_key       /etc/letsencrypt/live/dev.xenit.eu/privkey.pem;
                ssl_trusted_certificate   /etc/letsencrypt/live/dev.xenit.eu/chain.pem;

                root /var/www/nginx;

                error_page 401 /vpn_only.html;

                location / {
                return 401;
                }

                location = /vpn_only.html {
                internal;
                }
                }

            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end }}
